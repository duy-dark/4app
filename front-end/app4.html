<!DOCTYPE html>
<html>

<head>
    <title>app4</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="assets/css/cssapp4.css">
</head>

<body>
    <form action="">
        <input id="idtx" type="hidden"></input>
        <input id="idcd" type="hidden"></input>
    </form>
    <div class="tlphone">
        <div>
            <div id="chuadangnhap">
                <button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal" id="btnDN">
                    Đăng Nhập
                </button>
                <button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal1" id="btnDK">
                    Đăng Ký
                </button>
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog" style="z-index: 3;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title" id="myModalLabel">Đăng Nhập</h4>
                            </div>
                            <div class="modal-body" style="height: 168px;">
                                <div class="form-group">
                                    <div>
                                        <div class="row">
                                            <label for="userName" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 control-label">User Name:</label>
                                            <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8 ">
                                                <input type="text" class="form-control" id="fusername" name="fuserName" placeholder="Nhập username" data-error="Vui lòng nhập tên đăng nhập" required>
                                                <p class="help-block with-errors"> </p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <label for="password" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 control-label">Password:</label>
                                            <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8 ">
                                                <input type="password" class="form-control" id="fpassword" name="fpassword" placeholder="Nhập password" data-error="Vui lòng nhập password" required>
                                                <p class="help-block with-errors"> </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 ">
                                        <span id="loidangnhap" style="font-size: 10pt; display: none;" class="label label-danger">đăng nhập không thành công</span>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="">Close</button>
                                <button type="button" class="btn btn-primary" onclick="login()">Đăng Nhập</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title" id="myModalLabel">Đăng Ký</h4>
                            </div>
                            <div class="modal-body" style="height: 300px;">
                                <div class="form-group">
                                    <label for="hoTen" class="col-xs-4 col-sm-4 col-md-4 col-lg-4 control-label">Họ Tên:</label>
                                    <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8 ">
                                        <input type="text" class="form-control" id="hoten" name="fhoTen" placeholder="Nhập họ tên của bạn" data-error="Vui lòng nhập họ tên của bạn" required>
                                        <p class="help-block with-errors"> </p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="userNameDk" class="col-xs-4 col-sm-4 col-md-4 col-lg-4 control-label">User name:</label>
                                    <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8 ">
                                        <input type="text" class="form-control" id="username" name="fuserNameDk" placeholder="Nhập tên đăng nhập của bạn" data-error="Vui lòng nhập tên đăng nhập của bạn" required>
                                        <p class="help-block with-errors"> </p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="passwordDk" class="col-xs-4 col-sm-4 col-md-4 col-lg-4 control-label">Password:</label>
                                    <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8 ">
                                        <input type="password" class="form-control" id="password" name="fpasswordDk" placeholder="Nhập password của bạn" data-error="Vui lòng nhập password của bạn" required>
                                        <p class="help-block with-errors"> </p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="regist()">Đăng Ký</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dangnhaproi" style="display: none; left: none; height: 40px;">
                <div class="col-xs-6"><img src="./assets/image/e.png" style="width: 40px;height: 40px;" alt=""> <input style="width: 110px; height: 40px; " disabled id="daidien"></input>
                </div>
                <div class="col-xs-6"><button type="" class="btn form-control btn-info" onclick="logout()"> Đăng Xuất</button></div>
            </div>
            <input type="hidden" id="start">
            <input type="hidden" id="end">
            <div id="map">
            </div>
            <br>
            <div style="float: left;display: none; " id="taixesd">
                <div class="col-sm-3" style="width: 70px;">
                    <button type="button" id="themcd" class="btn btn-info" style="width: 60px; padding: 5px 5px;" onclick="themRQ()">Thêm</button>
                </div>
                <div class="col-sm-3" style="width: 70px;">
                    <button type="button" id="themcd" class="btn btn-info" style="width: 60px; padding: 5px 5px;" onclick="">bắt đầu</button>
                </div>
                <div class="col-sm-3" style="width: 70px;">
                    <button type="button" id="themcd" class="btn btn-info" style="width: 60px; padding: 5px 5px;" onclick="ketthuc()">Kết thúc</button>
                </div>
            </div>
            <div id="hotro">
                <select class="form-control" id="sel1">
                    <option>READY</option>
                    <option>STANDY</option>
                </select>
            </div>
        </div>
    </div>
    <div class="modaFormBackground2">
        <div id="dialogRequest">
            <div class="col-sm-3" style="width: 70px;">
                <button type="button" id="themcd" class="btn btn-info" style="width: 60px; padding: 5px 5px;" onclick="nhanRQ()">Nhận</button>
            </div>
            <div class="col-sm-3" style="width: 70px;">
                <button type="button" id="themcd" class="btn btn-info" style="width: 60px; padding: 5px 5px;" onclick="tuchoiRQ()">Từ Chối</button>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>
    <script src="assets/js/app4.js"></script>
    <script>
    var latlang1;
    var marker1, marker2, marker3, map;
    var dsden = [];
    var markerArray = [];
    if (typeof(Number.prototype.toRad) === "undefined") {
        Number.prototype.toRad = function() {
            return this * 3.14 / 180;
        }
    }

    function hvs2(latA, longA, latB, longB) {
        var dLat = (latA - latB).toRad();
        var dLon = (longA - longB).toRad();
        var dLatDiv2 = dLat / 2;
        var dLonDiv2 = dLon / 2;
        var latBRad = latB.toRad();
        var latBRadCos = Math.cos(latBRad);
        var dLatDiv2Sin = Math.sin(dLatDiv2);
        var dLonDiv2Sin = Math.sin(dLonDiv2);
        var a = dLatDiv2Sin * dLatDiv2Sin + latBRadCos * latBRadCos * dLonDiv2Sin * dLonDiv2Sin;
        return parseInt(6371 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)) * 1000);
    }

    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(p) {
                LatLng = new google.maps.LatLng(p.coords.latitude, p.coords.longitude);
                map = new google.maps.Map(document.getElementById("map"), {
                    center: LatLng,
                    zoom: 15,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                });
                google.maps.event.addListener(map, 'click', function(event) {
                    if (hvs2(p.coords.latitude, p.coords.longitude, event.latLng.lat(), event.latLng.lng()) <= 100) {
                        var data = {};

                        data.lat = event.latLng.lat();
                        data.lng = event.latLng.lng();
                        data.IDTX = $('#idtx').val();
                        data.token = window.localStorage.getItem('actoken4');
                        $.ajax({
                            url: 'http://localhost:3000/datxe/updateposition',
                            data: JSON.stringify(data),
                            type: 'POST',
                            contentType: 'application/json'
                        }).done(function(data) {
                            marker1.setPosition({ lat: parseFloat(data.TOADON), lng: parseFloat(data.TOADOW) });

                        }).fail(function(err) {
                            alert(err);
                        });
                    }
                });
                //$('#start').val(latLng); lưu revercoding tai xe
                var image = {
                    url: './assets/image/tx1.png',
                    // Kích cỡ hình
                    size: new google.maps.Size(50, 50),
                    // Gốc cho hình là oo
                    origin: new google.maps.Point(0, 0),
                    // Neo cho hình là 0, 32
                    anchor: new google.maps.Point(50, 50),
                    scaledSize: new google.maps.Size(40, 40)
                };
                marker1 = new google.maps.Marker({
                    position: LatLng,
                    map: map,
                    icon: image,
                    title: "<div style = 'height:60px;width:200px'><b>Your location:</b><br />Latitude: " + p.coords.latitude + "<br />Longitude: " + p.coords.longitude
                });
                markerArray[0] = marker1;
                marker3 = new google.maps.Marker();
                google.maps.event.addListener(marker1, "click", function(e) {
                    var infoWindow = new google.maps.InfoWindow();
                    infoWindow.setContent(marker1.title);
                    infoWindow.open(map, marker1);

                });
            });
        } else {
            alert('Geo Location feature is not supported in this browser.');
        }

    }

    function setMarker(latlng, map, title) {
        map.setCenter(latlng);
        marker2 = new google.maps.Marker({
            position: latlng,
            map: map,
            title: title
        });

    }
    function ketthuc(){
        var data = {};
        data.IDTX = $('#idtx').val();
        data.IDCD = $('#idcd').val();
        data.token = window.localStorage.getItem('actoken4');
        $.ajax({
            url: 'http://localhost:3000/datxe/endcd',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json'
        }).done(function(data){

        }).fail(function(err){
            console.log(err);
        })
    }
    function themRQ() {
        var data = {};
        data.dsden = dsden;

        var fn = function() {
            data.IDTX = $('#idtx').val();
            data.token = window.localStorage.getItem('actoken4');
            $.ajax({
                url: 'http://localhost:3000/datxe/getcd12',
                data: JSON.stringify(data),
                type: 'POST',
                contentType: 'application/json',
                timeout: 60000
            }).done(function(data) {
                $('.modaFormBackground2').css('display', 'block');
                //alert(JSON.stringify(data));
                latlang1 = { lat: parseFloat(data.TOADON), lng: parseFloat(data.TOADOW) };
                title = data.DIEMDI;
                $('#idcd').val(data.IDCD)
                setMarker(latlang1, map, title);
            }).fail(function(err) {
                setTimeout(fn, 1000);
            });
        }
        fn();
    }

    function nhanRQ() {
        var data = {};
        data.IDTX = $('#idtx').val();
        data.IDCD = $('#idcd').val();
        data.token = window.localStorage.getItem('actoken4');
        $.ajax({
            url: 'http://localhost:3000/datxe/getcd',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json'
        }).done(function(data) {
            
            latlang1 = { lat: parseFloat(data.TOADON), lng: parseFloat(data.TOADOW) };
            //$('#end').val(latlang1); lưu revercoding khách khi nhận
            title = data.DIEMDI;
            setMarker(latlang1, map, title);
            markerArray[1] = marker2;
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({ map: map });
            var stepDisplay = new google.maps.InfoWindow;
            calculateAndDisplayRoute(directionsDisplay, directionsService, markerArray, stepDisplay, map);
            var onChangeHandler = function() {
                calculateAndDisplayRoute(
                    directionsDisplay, directionsService, markerArray, stepDisplay, map);
            };
            document.getElementById('start').addEventListener('change', onChangeHandler);
            document.getElementById('end').addEventListener('change', onChangeHandler);
        }).fail(function(err) {
            alert(err);
        });
    }

    function calculateAndDisplayRoute(directionsDisplay, directionsService,
        markerArray, stepDisplay, map) {
        // First, remove any existing markers from the map.
       /* for (var i = 0; i < markerArray.length; i++) {
            markerArray[i].setMap(null);
        }
*/
        // Retrieve the start and end locations and create a DirectionsRequest using
        // WALKING directions.
        directionsService.route({
            origin: document.getElementById('start').value,
            destination: document.getElementById('end').value,
            travelMode: 'WALKING'
        }, function(response, status) {
            // Route the directions and pass the response to a function to create
            // markers for each step.
            if (status === 'OK') {
               /* document.getElementById('warnings-panel').innerHTML =
                    '<b>' + response.routes[0].warnings + '</b>';*/
                directionsDisplay.setDirections(response);
                showSteps(response, markerArray, stepDisplay, map);
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });
    }

    function showSteps(directionResult, markerArray, stepDisplay, map) {
        // For each step, place a marker, and add the text to the marker's infowindow.
        // Also attach the marker to an array so we can keep track of it and remove it
        // when calculating new routes.
        var myRoute = directionResult.routes[0].legs[0];
        for (var i = 0; i < myRoute.steps.length; i++) {
            var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
            marker.setMap(map);
            marker.setPosition(myRoute.steps[i].start_location);
            attachInstructionText(
                stepDisplay, marker, myRoute.steps[i].instructions, map);
        }
    }

    function attachInstructionText(stepDisplay, marker, text, map) {
        google.maps.event.addListener(marker, 'click', function() {
            // Open an info window when the marker is clicked on, containing the text
            // of the step.
            stepDisplay.setContent(text);
            stepDisplay.open(map, marker);
        });
    }

    function tuchoiRQ() {
        var data = {};
        data.IDCD = $('#idcd').val();

        var storedsden;
        if (window.localStorage.getItem('dsden')) {
            storedsden = JSON.parse(localStorage.getItem('dsden'));
            var lends = storedsden.length;
            dsden[lends] = $('#idcd').val();
            window.localStorage.removeItem('dsden');
            window.localStorage.setItem('dsden', JSON.stringify(dsden));

        } else {
            dsden[0] = $('#idcd').val();
            window.localStorage.setItem('dsden', JSON.stringify(dsden));
        }

        data.token = window.localStorage.getItem('actoken4');
        $.ajax({
            url: 'http://localhost:3000/datxe/getcdtc',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json'
        }).done(function(data) {
            marker2.setMap(null);
        }).fail(function(err) {
            alert(err);
        });

    }

    $(function() {
        document.getElementById('hotro').style.display = 'none';
        if (1 === 1) {
            initMap();
        }


        if (window.localStorage.getItem('user4')) {

            document.getElementById('chuadangnhap').style.display = 'none';
            var data1 = {};
            data1.refeshToken = window.localStorage.getItem('refresh4');
            var fn = function() {
                if (window.localStorage.getItem('user4')) {
                    $.ajax({
                            url: 'http://localhost:3000/newtoken/createtoken',
                            type: 'POST',
                            data: JSON.stringify(data1),
                            contentType: 'application/json',
                            timeout: 10000,
                            success: function(data2, textstatus, xhr) {
                                // alert(xhr.status);
                            }
                        }).done(function(data2) {
                            window.localStorage.setItem('actoken4', data2.access_token);
                            console.log('askfhkajsfhklsaf');

                        })
                        .catch(function(err) {
                            console.log('o day');
                        });

                    setTimeout(fn, 58000);
                }
            }
            fn();

        }

    });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBLyWj-3FWtCbCXGW3ysEiI2fDfrv2v0Q"></script>
</body>

</html>